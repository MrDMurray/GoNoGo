<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Activity Safety Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="relative text-gray-900 text-lg sm:text-xl">
    <video id="bg-video" autoplay loop muted>
        <source src="https://quacksolution.com/background.mp4" type="video/mp4">
    </video>
    <div id="bg-overlay"></div>
    

    <div class="flex flex-col items-center pt-8 min-h-screen">
        <h1 class="text-3xl font-bold text-white drop-shadow mb-4">Swimming in Skerries Harbour</h1>
        <div id="arrow-container" class="mt-4 flex justify-center">
            <img id="wind-arrow" src="http://quacksolution.com/wind_arrow.png" alt="Wind direction arrow" aria-hidden="true" class="w-1/3 sm:w-1/4">
        </div>
        <div id="current-conditions-section" class="mt-2 text-white font-bold drop-shadow text-center">
            <h3 class="subheading text-white font-bold drop-shadow">Current Conditions</h3>
            <p id="current-conditions" class="current-conditions"></p>
        </div>
        <div class="form-wrapper bg-white bg-opacity-95 rounded-xl shadow-2xl p-6 sm:p-8 w-11/12 max-w-xl">

            <form method="post" class="input-form grid gap-4">
                <div>
                    <label for="forecast-slider" class="block font-medium">Forecast time</label>
                    <input type="range" id="forecast-slider" min="0" max="0" value="0" class="w-full">
                    <div id="forecast-time" class="text-center text-sm mt-1"></div>
                    <div id="tide-section" class="mt-2 text-sm">
                        <table id="tide-table" class="tide-table w-full text-left border-collapse">
                            <thead>
                                <tr><th class="px-1">Time</th><th class="px-1">Tide</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <label for="location" class="block font-medium">Location</label>
                    <select name="location" id="location" class="mt-1 w-full p-2 border rounded">
                        {% for loc in locations %}
                        <option value="{{ loc }}" {% if loc == form_data.location %}selected{% endif %}>{{ loc }}</option>
                        {% endfor %}
                    </select>
                </div>


                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="p-2 bg-blue-50 rounded shadow">
                        <label class="block font-medium">Wind speed (km/h)</label>
                        <p id="wind_speed" class="mt-1">{{ form_data.wind_speed }}</p>
                    </div>

                    <div class="p-2 bg-blue-50 rounded shadow">
                        <label class="block font-medium">Wind direction (deg)</label>
                        <p id="wind_direction" class="mt-1">{{ form_data.wind_direction }}</p>
                    </div>

                    <div class="p-2 bg-blue-50 rounded shadow">
                        <label class="block font-medium">Wave Conditions</label>
                        <p id="wave_conditions" class="mt-1">-</p>
                    </div>

                    <div class="p-2 bg-blue-50 rounded shadow">
                        <label class="block font-medium">Water Quality</label>
                        <p id="water_quality" class="mt-1">-</p>
                    </div>

                    <div class="p-2 bg-blue-50 rounded shadow">
                        <label class="block font-medium">Sea Temperature</label>
                        <p id="sea_temperature" class="mt-1">-</p>
                    </div>

                    <div class="p-2 bg-blue-50 rounded shadow">
                        <label class="block font-medium">Air Temperature</label>
                        <p id="air_temperature" class="mt-1">-</p>
                    </div>

                    <div class="p-2 bg-blue-50 rounded shadow">
                        <label class="block font-medium">Sunset</label>
                        <p id="sunset" class="mt-1">-</p>
                    </div>

                    <div class="p-2 bg-blue-50 rounded shadow">
                        <label class="block font-medium">Sunrise</label>
                        <p id="sunrise" class="mt-1">-</p>
                    </div>
                </div>



            </form>
            <a href="https://britishcanoeingawarding.org.uk/wp-content/files/01042018BCABEnvironmentalDefinitionsDeploymentGuidanceForInstructorsCoachesLeadersV2-4Jan23.pdf" class="text-blue-700 underline block mt-4">See full BCAB Guidelines here</a>
            <a href="/" class="text-blue-700 underline block mt-2">Return to Home</a>
        </div>
    </div>

    <script>
        const windDirInput = document.getElementById('wind_direction');
        const windArrow = document.getElementById('wind-arrow');
        const windSpeedInput = document.getElementById('wind_speed');
        const forecastSlider = document.getElementById('forecast-slider');
        const forecastTime = document.getElementById('forecast-time');
        let forecastData = [];
        let tideData = [];
        const arrowImages = {
            1: "http://quacksolution.com/force1.png",
            2: "http://quacksolution.com/force2.png",
            3: "http://quacksolution.com/force3.png",
            4: "http://quacksolution.com/force4.png"
        };
        const tideTableBody = document.querySelector('#tide-table tbody');
        function beaufortForce(speed) {
            if (speed >= 1 && speed <= 5) return 1;
            if (speed >= 6 && speed <= 11) return 2;
            if (speed >= 12 && speed <= 19) return 3;
            if (speed >= 20 && speed <= 28) return 4;
            return null;
        }

        function beaufortForceDescription(speed) {
            const force = beaufortForce(speed);
            if (force === 1) return 'Force 1 Light Air';
            if (force === 2) return 'Force 2 Light Breeze';
            if (force === 3) return 'Force 3 Gentle Breeze';
            if (force === 4) return 'Force 4 Moderate Breeze';
            return 'Calm';
        }

        function cardinalDirection(angle) {
            const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round((angle % 360) / 45) % 8;
            return dirs[index];
        }

        function getNearestForecastIndex(now) {
            let idx = 0;
            let diff = Infinity;
            forecastData.forEach((item, i) => {
                const d = Math.abs(new Date(item.dtg) - now);
                if (d < diff) {
                    diff = d;
                    idx = i;
                }
            });
            return idx;
        }

        function updateTideTable() {
            if (!tideData.length) return;
            let selDate = null;
            if (forecastData.length) {
                const sel = forecastData[parseInt(forecastSlider.value)];
                if (sel) selDate = new Date(sel.dtg);
            }
            if (!selDate) {
                selDate = new Date(tideData[0].dtg);
            }
            const dateStr = selDate.toISOString().split('T')[0];
            const dayTides = tideData.filter(t => t.dtg.startsWith(dateStr));
            dayTides.sort((a,b) => new Date(a.dtg) - new Date(b.dtg));
            const highlight = [...dayTides]
                .sort((a,b)=>Math.abs(new Date(a.dtg)-selDate)-Math.abs(new Date(b.dtg)-selDate))
                .slice(0,2)
                .map(t=>t.dtg);
            tideTableBody.innerHTML = '';
            dayTides.forEach(t => {
                const tr = document.createElement('tr');
                if (highlight.includes(t.dtg)) tr.classList.add('highlight-tide');
                const timeTd = document.createElement('td');
                timeTd.textContent = new Date(t.dtg).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const typeTd = document.createElement('td');
                typeTd.textContent = t.type;
                tr.appendChild(timeTd);
                tr.appendChild(typeTd);
                tideTableBody.appendChild(tr);
            });
        }

        function updateCurrentConditions() {
        const speed = parseFloat(windSpeedInput.textContent) || 0;
        const dir = parseFloat(windDirInput.textContent) || 0;
            const text = `${speed} km/h from ${cardinalDirection(dir)} - ${beaufortForceDescription(speed)}`;
            document.getElementById('current-conditions').textContent = text;
        }

        function applyForecast() {
            const idx = parseInt(forecastSlider.value);
            const item = forecastData[idx];
            if (!item) return;
            windSpeedInput.textContent = item.speed;
            windDirInput.textContent = item.direction;
            const dt = new Date(item.dtg);
            const weekday = dt.toLocaleDateString('en-US', {weekday: 'long'});
            forecastTime.textContent = `${weekday} ${dt.toLocaleString()}`;
            updateWindArrow();
            updateCurrentConditions();
            updateTideTable();
        }


        function updateWindArrow() {
            const angle = parseFloat(windDirInput.textContent) || 0;
            const speed = parseFloat(windSpeedInput.textContent) || 0;
            const force = beaufortForce(speed);
            if (force) {
                windArrow.src = arrowImages[force];
            } else {
                windArrow.src = "http://quacksolution.com/wind_arrow.png";
            }
            windArrow.style.transform = `rotate(${angle - 180}deg)`;
        }

        if (forecastSlider) {
            forecastSlider.addEventListener('input', () => {
                applyForecast();
            });
        }

        // Initialize on load
        updateWindArrow();
        updateCurrentConditions();

        window.addEventListener('DOMContentLoaded', () => {
            const loading = document.getElementById('loading-message');
            if (loading) loading.classList.remove('hidden');
            Promise.all([
                fetch('/forecast').then(r => r.json()),
                fetch('/tides').then(r => r.json())
            ])
                .then(([fData, tData]) => {
                    if (!fData.error && fData.length) {
                        forecastData = fData;
                        forecastSlider.max = fData.length - 1;
                        forecastSlider.value = getNearestForecastIndex(new Date());
                        applyForecast();
                    } else if (loading) {
                        loading.textContent = 'Could not load weather data.';
                    }
                    if (tData && !tData.error) {
                        tideData = tData;
                        updateTideTable();
                    }
                })
                .catch(() => {
                    if (loading) loading.textContent = 'Could not load weather data.';
                })
                .finally(() => {
                    setTimeout(() => {
                        if (loading) loading.classList.add('hidden');
                    }, 1000);
                });
        });
    </script>
</body>
</html>
