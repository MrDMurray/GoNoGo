<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Activity Safety Check</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- Wind arrow overlay -->
    <img id="wind-arrow" src="http://quacksolution.com/wind_arrow.png" alt="Wind arrow">

    <div class="form-wrapper">
        <h1>Water Activity GO/NO GO</h1>
        <div id="loading-message" class="loading-message" style="display:none;">
            Loading latest weather data from Dublin Airport...
        </div>
        <form method="post" class="input-form">
            <label for="location">Location:</label>
            <select name="location" id="location">
                {% for loc in locations %}
                <option value="{{ loc }}" {% if loc == form_data.location %}selected{% endif %}>{{ loc }}</option>
                {% endfor %}
            </select><br>

            <label for="environment">Environment:</label>
            <select name="environment" id="environment">
                {% for env in environments %}
                <option value="{{ env }}" {% if env == form_data.environment %}selected{% endif %}>{{ env }}</option>
                {% endfor %}
            </select><br>

            <label for="distance">Distance from shore (m):</label>
            <input type="number" step="1" min="0" name="distance" id="distance" value="{{ form_data.distance }}" required><br>

            <label for="wind_speed">Wind speed (km/h):</label>
            <input type="number" step="0.1" name="wind_speed" id="wind_speed" value="{{ form_data.wind_speed }}" required><br>

            <label for="wind_direction">Wind direction (deg):</label>
            <input type="number" step="1" min="0" max="360" name="wind_direction" id="wind_direction" value="{{ form_data.wind_direction }}" required>
            <br>

            <label for="solo_participants">Solo craft participants:</label>
            <input type="number" min="0" name="solo_participants" id="solo_participants" value="{{ form_data.solo_participants }}" required><br>

            <label for="crew_participants">Crew craft participants:</label>
            <input type="number" min="0" name="crew_participants" id="crew_participants" value="{{ form_data.crew_participants }}" required><br>

            <label for="coaches">Qualified coaches/leaders:</label>
            <input type="number" min="0" name="coaches" id="coaches" value="{{ form_data.coaches }}" required><br>

            <button type="submit" class="action-btn">Check</button>
            <button type="button" id="reload-weather" class="action-btn">Reload Weather from Met Ã‰ireann</button>
        </form>

        {% if decision %}
        <h2 class="{{ decision_class }}">{{ decision }}</h2>
        <ul class="reasons">
            {% for r in reasons %}
            <li>{{ r }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <script>
        const locationImages = {
            "Skerries Sailing Club": "http://quacksolution.com/SkerriesSailingClub.png",
            "Skerries South Beach": "http://quacksolution.com/SkerriesSouthBeach.png"
        };

        const locationSelect = document.getElementById('location');
        const windDirInput = document.getElementById('wind_direction');
        const windArrow = document.getElementById('wind-arrow');
        const windSpeedInput = document.getElementById('wind_speed');
        const arrowImages = {
            1: "http://quacksolution.com/force1.png",
            2: "http://quacksolution.com/force2.png",
            3: "http://quacksolution.com/force3.png",
            4: "http://quacksolution.com/force4.png"
        };
        function beaufortForce(speed) {
            if (speed >= 1 && speed <= 5) return 1;
            if (speed >= 6 && speed <= 11) return 2;
            if (speed >= 12 && speed <= 19) return 3;
            if (speed >= 20 && speed <= 28) return 4;
            return null;
        }

        function updateBackground() {
            const url = locationImages[locationSelect.value];
            if (url) {
                document.body.style.backgroundImage = `url('${url}')`;
            }
        }

        function updateWindArrow() {
            const angle = parseFloat(windDirInput.value) || 0;
            const speed = parseFloat(windSpeedInput.value) || 0;
            const force = beaufortForce(speed);
            if (force) {
                windArrow.src = arrowImages[force];
            } else {
                windArrow.src = "http://quacksolution.com/wind_arrow.png";
            }
            windArrow.style.transform = `rotate(${angle - 180}deg)`;
        }

        locationSelect.addEventListener('change', updateBackground);
        windDirInput.addEventListener('input', updateWindArrow);
        windSpeedInput.addEventListener('input', updateWindArrow);

        // Initialize on load
        updateBackground();
        updateWindArrow();
        const reloadBtn = document.getElementById('reload-weather');
        if (reloadBtn) {
            reloadBtn.addEventListener('click', () => {
                window.location.href = '/';
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            {% if not decision %}
            const loading = document.getElementById('loading-message');
            loading.style.display = 'block';
            fetch('/wind')
                .then(r => r.json())
                .then(data => {
                    if (!data.error) {
                        windSpeedInput.value = data.speed;
                        windDirInput.value = data.direction;
                    } else {
                        loading.textContent = 'Could not load weather data.';
                    }
                    updateWindArrow();
                })
                .catch(() => {
                    loading.textContent = 'Could not load weather data.';
                })
                .finally(() => {
                    setTimeout(() => {
                        loading.style.display = 'none';
                        document.querySelector('.input-form').submit();
                    }, 1000);
                });
            {% endif %}
        });
    </script>
</body>
</html>
